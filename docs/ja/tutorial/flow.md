# フローの設計

## フロー

プロジェクトと3つのテンプレートを作成しましたが、テンプレートの順序はどのように定義すればよいのでしょうか？
ここで、**フロー**を紹介します。

フローにより、次のことが可能になります。
- 複数のテンプレートをユーザーに表示する順序を定義する
- 複数のテンプレートをグループ化し、それらをバッチとして管理する
- ルールを適用することで、特定のバッチ/テンプレートをスキップ、反復、または中断可能にする

私たちは、Human-In-The-Loop AIのエンジニア、研究者、または企業の社内アノテーターが、彼らの独自の目標を達成可能なアノテーションシステムを動作するために必要としうる、さまざまなタイプのシステムインタラクションの形を研究しています。
Tuttiの**フロー**設計においては、必要に応じて複雑で詳細なフローを構築でき、かつ必要な知識は最小限で済みます。

### 手順

1. Tuttiコンソールの左側のメニューで、[Task Flow]をクリックします。この時点では、「Start」と「End」という名前のボックスと、いくつかの下向き矢印が表示されているだけです。
2. `first-project`プロジェクトのスキームの設定ファイル（`tutti/projects/first-project/scheme.py`）を開きます。
3. `scheme.py`を次のように編集し、保存します。

```python
from libs.scheme import ProjectSchemeBase
from libs.scheme.flow import BatchNode, TemplateNode, Statement

class ProjectScheme(ProjectSchemeBase):

    ...

    def define_flow(self):
        t_pre = TemplateNode("preliminary")

        t_main1 = TemplateNode("main1")
        t_main2 = TemplateNode("main2")
        b_main = BatchNode("main",
                           [t_main1, t_main2],
                           statement=Statement.WHILE,
                           condition=self.b_main_cond)

        t_post = TemplateNode("post")

        return BatchNode("all", children=[t_pre, b_main, t_post])

    def b_main_cond(self, wkr_client, ws_client): 
        return ws_client.cnt("main")<5
  ```
4. ブラウザコンソールに戻り、<svg width="24" height="24" viewBox="0 0 24 24"><path d="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z" /></svg>アイコンをクリックしてフローをリロードします。
以下のようなフローチャートがページに表示されれば、準備は完了です。

!> フローチャートがロードされない場合は、`scheme.py`ファイルに構文エラーまたは変数エラーがある可能性があります。

  <img src="./_media/flow.png" width="500" />

フロー構成完了です。おめでとうございます:tada:
これでとりあえずは、アノテーションプロジェクトは既に公開できる状態です。**驚くほど簡単ですね！**
早速どうなっているか見てみましょう。ただその前に、今起こったことを要約するために少しだけ時間をください。

### フローの理解

レンダリングされたフローチャートを見れば、フローの意味を理解するのは難しいことではないと思います。
灰色の長方形のカードは、特定の機能が適用されるバッチ（タスクグループ）を表し、青い形のカードは、ユーザーが入力を行うためにレンダリングされる実際のタスクであるテンプレートを表します。

アノテーションタスクがユーザーによって開始されると、`preliminary`タスクがユーザーに表示されます。
そのタスクの回答を送信すると、今度はメインタスクのバッチが開始されます。`main1`が最初に表示され、その後には`main2`が表示されます。
その後はどうなるでしょうか？チャートに「**LOOP condition**」が示されているように、ユーザーは再び`main1`に戻っては`main2`に移り、というのを合計5回反復します。
そして最後に、`post`タスクが割り当てられます。それが送信されると、ユーザーはタスクセッションを終了します。

### フロー設計API

`scheme.py`で行っているのは、上記と同じフロー構造を`TemplateNode`と`BatchNode`を積み木のように構築して表現しているだけです。
どちらのタイプのノードも、通常、名前やif / whileステートメントや条件などの同じ引数のセットを取りますが、`BatchNode`では特に複数の`TemplateNode`を子ノードとします。
また、フロー全体を最も外側ののバッチでラップしてから、`define_flow()`関数において返す必要があることに注意してください。

フロー設計APIの詳細については、[プログラミングリファレンス>プロジェクトスキーム](./guide/ref_scheme)を参照してください。

## 静的テンプレートを使用したテスト実行

### 手順

1. ブラウザコンソールで、上部のドロップダウンメニューで"**first-project**"プロジェクトが選択されていることを確認し、<svg width="24" height="24" viewBox="0 0 24 24"><path d="M12,16A2,2 0 0,1 14,18A2,2 0 0,1 12,20A2,2 0 0,1 10,18A2,2 0 0,1 12,16M12,10A2,2 0 0,1 14,12A2,2 0 0,1 12,14A2,2 0 0,1 10,12A2,2 0 0,1 12,10M12,4A2,2 0 0,1 14,6A2,2 0 0,1 12,8A2,2 0 0,1 10,6A2,2 0 0,1 12,4Z" /></svg>アイコンをクリックして[**Launch in Production Mode (Private)**]を選択します。

2. 新しいページタブが表示されたら、ワーカー名として「**testworker**」と入力し、「LOGIN」をクリックします。

3. これで、作成したタスクのワーカーとしてタスクを開始し、最初に`preliminary`タスクが表示されるはずです。フォームへ回答を入力し、[NEXT]をクリックして続行するという作業を、`post`タスクが表示されるまで続行します。

  <img src="./_media/task-sample.gif" width="600" />
  
  ?> タスクテンプレートは、回答が保存された状態で前後に移動できます。上部の<svg width="24" height="24" viewBox="0 0 24 24"><path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" /></svg><svg width="24" height="24" viewBox="0 0 24 24"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>ボタンをクリックしてみてください。

4. `post`タスクのフォームに記入し、「NEXT」をクリックします。ページがリロードされ（フロー全体が完了したことを意味する）、`preliminary`タスクが再度表示されることを確認してください。
